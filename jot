#!/usr/bin/env ruby
require 'sinatra'
require 'erb'
require 'sqlite3'
require 'haml'

def show(template, context = nil)
    # This method wraps whatever other template you want to use inside the
    # standard index HTML boilerplate
    #
    # Call this method like this:
    #
    #   1.) show <templatename(symbol), <localVariable symbol> => <value of local variable>
    #       In the template, refer to your variables using localVariable
    #
    #       See an example in the get '/list' route, using the 'list' template: 
    #           show :list, :jots => @jots
    #   2.) Or, just pass it a string, and it will use that for the content in the regular index template
    if (template.class == String)
        @content = template
        erb :index 
    else
        @content = erb template, :locals => context
        erb :index
    end
end

def get_db
    db = SQLite3::Database.open "jots.db"
    db.results_as_hash = true
    return db
end

get '/db' do

    content = begin
        db = SQLite3::Database.new "jot"
        "DB Version: #{db.get_first_value 'SELECT SQLITE_VERSION()'}"
    rescue SQLite3::Exception => e
        "Exception occurred: #{e}"
    ensure
        db.close if db
    end

    show content
end

get '/' do
    erb :index
end

get '/list' do
    db = get_db
    @jots = db.execute("select body from jots");
    erb :list, :locals => { :jots => @jots }
end

get '/create' do
    show :create
end

get '/menu' do
    erb :menu
end

put '*' do
    body = params['body'];
    db = get_db

    result = begin
        db.execute("insert into Jots (body) values('#{body}')")
        "Jot successfully created"
    rescue SQLite3::Exception => e
        "DB Error: #{e}"
    ensure
        db.close if db
    end

    return result
end
